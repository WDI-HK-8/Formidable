app.filter('orderFieldBy', function(){
 return function(input, attribute) {
    if (!angular.isObject(input)) return input;

    var array = [];
    for(var objectKey in input) {
        array.push(input[objectKey]);
    }

    array.sort(function(a, b){
        a = parseInt(a[attribute]);
        b = parseInt(b[attribute]);
        return a - b;
    });
    return array;
 }
});

app.controller('FormsUpdateCtrl', ['$scope', '$http', '$auth', '$location', '$routeParams','$rootScope', function($scope, $http, $auth, $location, $routeParams, $rootScope){

  $rootScope.title = 'Design';
  url = "<%= ENV['URL'] %>" || 'http://localhost:3000'

  $scope.categories = ['text','textarea','dropdown','checkboxes','radio','description'] //All the categories of content available to add to your form

  $scope.fields = [] //All the contents in the form

  //List the contents
  $http.get(url + '/forms/' + $routeParams.id).success(function(response) {
    $scope.name = response.name;
    response.contents.forEach(function(content) {
      $scope.fields.push(content);
    })
  })

  //Add a new content
  $scope.add = function(elem) {
    $scope.content = {
      label: '',
      options: [],
      category: elem.toString(),
      index: $scope.fields.length
    };

    $http.post(url + '/forms/' + $routeParams.id + '/contents',$scope.content).success(function(response) {
    $scope.fields.push(response);
    }).error(function(response) {
    });
  };

 //Reorganise the fields array by index
  var compare = function(a,b) {
    if (a.index < b.index)
      return -1;
    if (a.index > b.index)
      return 1;
    return 0;
  }

  //Re-assign the index of the contents
  var reIndexField = function(){
    $scope.fields.sort(compare);
    //Re-assign a new index
    for(var i = 0; i < $scope.fields.length; i++){
      $scope.fields[i].index = i
      var content = $scope.fields[i];
      $http.put(url + '/contents/' + content.id,content).success(function(response) {
      });
    }
  };

  //Delete a content
  $scope.delete = function(field){
    $http.delete(url + '/contents/' + field.id).success(function(response){
      $scope.fields.splice($scope.fields.indexOf(field),1)
      reIndexField();
    })
  }
  
  $scope.options = []; //List of choices in a dropdown menu or checkboxes
  $scope.input = {}; //encapsulate the inputs

  //Edit panel is hidden by default
  $scope.editPanelVisible = false;
  
  //Show Edit panel
  $scope.displayEditPanel = function(field){
    $http.get(url + '/contents/' + field.id).success(function(response){
      $scope.editPanelVisible = true;
      $scope.field = response;
      console.log(response);

      $scope.options = [];
      $scope.options = $scope.field.options;

      $scope.input.labelInput = response.label;
      $scope.input.textInput = response.options[0];

    }).error(function(response){
      console.log(response);
    })
  }

  //Add options for dropdown
  $scope.addOptions = function(newOptionEntry){
    $scope.options.push(newOptionEntry);
  }

  //Add a text area in the array options
  $scope.addDescription = function(newOptionEntry){
    $scope.options = [];
    $scope.addOptions(newOptionEntry);
  }

  //Delete an option
  $scope.deleteOption = function(option){
    $scope.options.splice($scope.options.indexOf(option),1);
  }

  //Hide panel without saving
  $scope.quitEditPanel = function(){
    $scope.editPanelVisible = false;
  }

  //Update and hide options
  $scope.hideAndSaveEditPanel = function(field,labelInput){
    $scope.updatedContent = {
      label: labelInput,
      options: $scope.options,
      category: field.category,
      index: field.index
    };
    console.log($scope.updatedContent);
    $http.put(url + '/contents/' + field.id,$scope.updatedContent).success(function(response) {
      $scope.editPanelVisible = false;
      $scope.options = [];
      $http.get(url + '/forms/' + $routeParams.id).success(function(response) {
        $scope.fields = [];
        $scope.name = response.name;
        $scope.fields = response.contents;
      })

    }).error(function(response){
      console.log(response);
    });    
  }

  //Go to the preview page
  $scope.preview = function(){
    $location.path('forms/' + $routeParams.id + '/preview');
  }
}]);