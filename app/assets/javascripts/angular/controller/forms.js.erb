app.controller('ListFormsCtrl', ['$scope', '$http','$auth','$location','user', function($scope, $http, $auth, $location, user){
  
  url = "<%= ENV['URL'] %>" || 'http://localhost:3000'

  $scope.noForms = false;

  $http.get(url + '/users/' + user.id + '/forms').success(function(resp) {
    $scope.forms = resp;
    if(!resp.length) {
      $scope.noForms = true;
    }
  });

  $scope.form = {};
  $scope.createForm = function() {
    $http.post(url + '/forms',$scope.form).success(function(response) {
      console.log(response)
      $location.path('forms/' + response.id + '/edit');
    }).error(function(response){
      alert("write something you douche");
    });
  }
}]);

app.controller('FormsUpdateCtrl', ['$scope', '$http', '$auth', '$location', '$routeParams', function($scope, $http, $auth, $location, $routeParams){

  url = "<%= ENV['URL'] %>" || 'http://localhost:3000'

  $scope.fields = [] //All the contents in the form

  //List the contents
  $scope.name = '';

  $http.get(url + '/forms/' + $routeParams.id).success(function(response) {
    console.log(response)
    $scope.name = response.name;
    response.contents.forEach(function(content) {
      $scope.fields.push(content);
    })
  })

  //Add a new content
  $scope.add = function(elem) {
    $scope.content = {
      label: '',
      options: [],
      category: elem.toString(),
      index: $scope.fields.length
    };

    $http.post(url + '/forms/' + $routeParams.id + '/contents',$scope.content).success(function(response) {
    $scope.fields.push(response);
      console.log(response);
    }).error(function(response) {
      console.log(response);
    });

    console.log($scope.fields)
  };

  //Delete a content
  $scope.delete = function(field){
    $http.delete(url + '/contents/' + field.id).success(function(response){
      $scope.fields.splice($scope.fields.indexOf(field),1)
      reIndexField();
    })
  }

  //Re-assign the index of the contents
  var reIndexField = function(){
    for(var i = 0; i < $scope.fields.length; i++){
      $scope.fields[i].index = i
      var content = $scope.fields[i];
      $http.put(url + '/contents/' + content.id,content).success(function(response) {
        console.log($scope.fields)
      });
    }
  };

}]);  

